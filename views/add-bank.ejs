<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Bank | WPG-Wallet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="d-flex flex-column" style="min-height: 100vh;">

  <!-- Header -->
  <%- include('partials/header', { user: user }) %>

    <!-- Main layout -->
    <div class="d-flex flex-grow-1">
      <!-- âœ… Keep My Banks highlighted -->
      <%- include('partials/nav', { currentRoute: 'banks' }) %>

        <main class="flex-grow-1 p-4 bg-white">
          <div class="container">
            <h3 class="mb-4">ðŸ”— Link a New Bank</h3>

            <!-- âœ… Plaid Button -->
            <div class="mb-4">
              <button id="plaidLinkBtn" class="btn btn-primary">Link with Plaid</button>
            </div>

            <!-- âœ… Manual Bank Form -->
            <form action="/add-bank" method="POST" class="bg-white p-4 rounded shadow-sm">
              <div class="mb-3">
                <label class="form-label">Bank Name</label>
                <input type="text" name="bankName" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Account Number</label>
                <input type="text" name="accountNumber" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Account Type</label>
                <select name="accountType" class="form-select" required>
                  <option value="Savings">Savings</option>
                  <option value="Checking">Checking</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Initial Balance</label>
                <input type="number" name="balance" step="0.01" class="form-control" required />
              </div>
              <button type="submit" class="btn btn-success">Link Bank</button>
              <a href="/banks" class="btn btn-secondary ms-2">Cancel</a>
            </form>
          </div>
        </main>
    </div>

    <!-- Footer -->
    <%- include('partials/footer') %>

      <!-- âœ… Plaid Script -->
      <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
      <script type="module">
        const linkBtn = document.getElementById("plaidLinkBtn");

        linkBtn?.addEventListener("click", async () => {
          try {
            const res = await fetch("/plaid/create-link-token");
            const { link_token } = await res.json();

            const handler = window.Plaid.create({
              token: link_token,
              onSuccess: async (public_token, metadata) => {
                await fetch("/plaid/exchange-token", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ public_token })
                });

                window.location.href = "/banks";
              },
              onExit: (err, metadata) => {
                console.warn("User exited Plaid", err);
              }
            });

            handler.open();
          } catch (err) {
            console.error("Plaid error:", err);
            alert("Failed to initialize Plaid.");
          }
        });
      </script>
</body>

</html>